<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marlin Configurator</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body>
    <div class="container mt-5">
        <h1>Marlin Configurator</h1>
        <div class="mb-3">
            <label for="configExampleSelect" class="form-label fw-bold">Select the configuration example to edit:</label>
            <select id="configExampleSelect" class="form-select w-auto">
                <option value="">-- Select --</option>
                <option value="btt-skr-cr6-with-btt-tft">btt-skr-cr6-with-btt-tft</option>
                <option value="btt-skr-cr6-with-btt-tft-biqu-h2">btt-skr-cr6-with-btt-tft-biqu-h2</option>
                <option value="btt-skr-cr6-with-btt-tft-e3d-hemera">btt-skr-cr6-with-btt-tft-e3d-hemera</option>
                <option value="btt-skr-cr6-with-stock-creality-tft">btt-skr-cr6-with-stock-creality-tft</option>
                <option value="btt-skr-cr6-with-stock-creality-tft-biqu-h2">btt-skr-cr6-with-stock-creality-tft-biqu-h2</option>
                <option value="btt-skr-cr6-with-stock-creality-tft-neopixel">btt-skr-cr6-with-stock-creality-tft-neopixel</option>
                <option value="cr10-smart-btt-skr-cr6-with-btt-tft">cr10-smart-btt-skr-cr6-with-btt-tft</option>
                <option value="cr10-smart-btt-skr-cr6-with-stock-creality-tft">cr10-smart-btt-skr-cr6-with-stock-creality-tft</option>
                <option value="cr6-max-btt-skr-cr6-with-btt-tft">cr6-max-btt-skr-cr6-with-btt-tft</option>
                <option value="cr6-max-btt-skr-cr6-with-stock-creality-tft">cr6-max-btt-skr-cr6-with-stock-creality-tft</option>
                <option value="cr6-max-stock-mb">cr6-max-stock-mb</option>
                <option value="cr6-se-v4.5.2-mb">cr6-se-v4.5.2-mb</option>
                <option value="cr6-se-v4.5.2-mb-no-watchdog">cr6-se-v4.5.2-mb-no-watchdog</option>
                <option value="cr6-se-v4.5.3-mb">cr6-se-v4.5.3-mb</option>
            </select>
            <div id="fileListArea" class="mt-2"></div>
        </div>
        <form method="POST" enctype="multipart/form-data" class="d-flex flex-wrap align-items-center gap-2 mb-2">
            <input class="form-control form-control-sm w-auto" type="file" id="configFile" name="configFile" accept=".h,.ini,.txt" style="max-width:220px; display:none;">
            <input class="form-control form-control-sm w-auto" type="url" id="configUrl" name="configUrl" placeholder="Paste config URL" style="max-width:220px; display:none;">
            {% if config_content %}
                <form method="POST" action="/edit" class="d-inline">
                    <input type="hidden" name="filename" value="{{ config_source.split('/')[-1] if config_source else 'configuration.h' }}">
                    <input type="hidden" name="editedConfig" id="editedConfigHidden">
                    <button type="submit" class="btn btn-success btn-sm ms-2" onclick="copyEditorContent()">Download Modified Config</button>
                </form>
            {% endif %}
        </form>
        {% if config_content %}
            <hr>
            {% if config_source %}
                <div class="small text-muted mb-2"><strong>Loaded file:</strong> {{ config_source }}</div>
            {% endif %}
            <div id="configEditor">
                <h2 class="mt-4">Edit {{ config_source|replace('https://','')|replace('github.com/','')|replace('raw.githubusercontent.com/','')|replace('blob/','')|replace('/','_') if config_source else 'Configuration' }}</h2>
                <div class="mb-2 d-flex flex-wrap align-items-center gap-2">
                    <input type="checkbox" id="hideComments" onclick="toggleComments()">
                    <label for="hideComments" class="me-2 mb-0">Hide Comments</label>
                    <label for="topicFilter" class="me-2 mb-0">Show:</label>
                    <select id="topicFilter" onchange="filterTopic()" class="form-select form-select-sm w-auto">
                        <option value="all">All Settings</option>
                        <option value="nozzle">Nozzle Temperature</option>
                        <option value="bed">Bed Temperature</option>
                        <option value="motors">Motors</option>
                        <option value="enable">Enable Settings</option>
                        <option value="setting">#define Sttings</option>
                        <option value="commented_define">Commented #define</option>
                    </select>
                    <label for="searchTerm" class="me-2 mb-0">Keyword Filter:</label>
                    <input type="text" id="searchTerm" class="form-control form-control-sm w-auto" placeholder="Type to filter..." oninput="refreshFilters()" style="max-width:140px;">
                    <button type="button" class="btn btn-outline-secondary btn-sm ms-2" onclick="viewInContext()">View in Context</button>
                </div>
                <div style="position:relative; width:100%; height:400px;">
                    <textarea class="form-control" name="editedConfig" id="configTextarea" rows="20" style="font-family:monospace; resize:vertical; height:100%; min-height:100%; box-sizing:border-box;">{{ config_content }}</textarea>
                </div>
            </div>
        {% endif %}
    </div>
    <script>
        function onConfigExampleChange() {
            const select = document.getElementById('configExampleSelect');
            window.selectedConfigFolder = select.value;
            const fileListArea = document.getElementById('fileListArea');
            fileListArea.innerHTML = '';
            if (select.value) {
                fetch(`/list-config-files?folder=${encodeURIComponent(select.value)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.files.length > 0) {
                            let html = '<div class="fw-bold">Files in selected folder:</div><ul class="list-group">';
                            for (let f of data.files) {
                                html += `<li class="list-group-item list-group-item-action" style="cursor:pointer;" onclick="loadConfigFile('${select.value}','${f}')">${f}</li>`;
                            }
                            html += '</ul>';
                            fileListArea.innerHTML = html;
                        } else {
                            fileListArea.innerHTML = '<div class="text-muted">No config files found in this folder.</div>';
                        }
                    })
                    .catch(err => {
                        console.error('Error fetching file list:', err);
                    });
            }
        }
        function loadConfigFile(folder, filename) {
            window.location.href = `/?folder=${encodeURIComponent(folder)}&filename=${encodeURIComponent(filename)}`;
        }
        document.addEventListener('DOMContentLoaded', function() {
            var select = document.getElementById('configExampleSelect');
            if (select) {
                select.onchange = function() {
                    onConfigExampleChange();
                    var fileInput = document.getElementById('configFile');
                    var urlInput = document.getElementById('configUrl');
                    if (select.value) {
                        fileInput.style.display = 'none';
                        urlInput.style.display = 'none';
                    } else {
                        fileInput.style.display = '';
                        urlInput.style.display = '';
                    }
                };
            }
            var fileInput = document.getElementById('configFile');
            if (fileInput) {
                fileInput.addEventListener('change', function(e) {
                    if (fileInput.files.length > 0 && window.selectedConfigFolder) {
                        const fileName = fileInput.files[0].name;
                        const loadedFileDiv = document.querySelector('.small.text-muted.mb-2');
                        if (loadedFileDiv) {
                            loadedFileDiv.innerHTML = `<strong>Loaded file:</strong> ./config/${window.selectedConfigFolder}/${fileName}`;
                        }
                        fileInput.form.submit();
                    }
                });
            }
        });
        let originalConfig = null;
        let filteredConfig = null;
        let lastFilteredLine = null;
        window.addEventListener('DOMContentLoaded', function() {
            if (document.getElementById('hideComments')) {
                document.getElementById('hideComments').checked = false;
            }
            if (document.getElementById('topicFilter')) {
                document.getElementById('topicFilter').value = 'all';
            }
            if (document.getElementById('searchTerm')) {
                document.getElementById('searchTerm').value = '';
            }
            if (document.getElementById('configTextarea')) {
                originalConfig = document.getElementById('configTextarea').value;
                document.getElementById('configTextarea').value = originalConfig;
                filteredConfig = originalConfig;
            }
        });
        function toggleComments() {
            const textarea = document.getElementById('configTextarea');
            let lines = originalConfig.split('\n');
            let filtered = [];
            let inBlock = false;
            for (let line of lines) {
                let trimmed = line.trim();
                if (trimmed.startsWith('/*')) inBlock = true;
                if (!inBlock && !trimmed.startsWith('//')) filtered.push(line);
                if (inBlock && trimmed.endsWith('*/')) inBlock = false;
            }
            if (document.getElementById('hideComments').checked) {
                filteredConfig = filtered.join('\n');
            } else {
                filteredConfig = originalConfig;
            }
            filterTopic();
        }
        function filterTopic() {
            const textarea = document.getElementById('configTextarea');
            let lines = filteredConfig.split('\n');
            let topic = document.getElementById('topicFilter').value;
            if (topic === 'all') {
                textarea.value = lines.join('\n');
                filterSearch();
                return;
            }
            let keywords = {
                nozzle: ['NOZZLE', 'TEMP_SENSOR', 'HEATER', 'HOTEND'],
                bed: ['BED', 'TEMP_SENSOR_BED', 'HEATER_BED'],
                motors: ['MOTOR', 'STEPPER', 'AXIS'],
                enable: ['ENABLE '],
                setting: ['#define']
            };
            let filtered;
            if (topic === 'setting') {
                filtered = lines.filter(line => line.trim().startsWith('#define'));
            } else if (topic === 'commented_define') {
                if (document.getElementById('hideComments').checked) {
                    filtered = [];
                } else {
                    filtered = lines.filter(line => line.trim().startsWith('//') && line.includes('#define'));
                }
            } else {
                filtered = lines.filter(line => {
                    for (let key of keywords[topic]) {
                        if (line.toUpperCase().includes(key)) return true;
                    }
                    return false;
                });
            }
            textarea.value = filtered.join('\n');
            lastFilteredLine = filtered.length > 0 ? filtered[filtered.length - 1] : null;
            filterSearch();
        }
        function filterSearch() {
            const textarea = document.getElementById('configTextarea');
            let searchTerm = document.getElementById('searchTerm').value.trim().toLowerCase();
            if (!searchTerm) return;
            let lines = textarea.value.split('\n');
            let filtered = lines.filter(line => line.toLowerCase().includes(searchTerm));
            textarea.value = filtered.join('\n');
            lastFilteredLine = filtered.length > 0 ? filtered[filtered.length - 1] : null;
        }
        function refreshFilters() {
            toggleComments();
            filterTopic();
            filterSearch();
        }
        function viewInContext() {
            const textarea = document.getElementById('configTextarea');
            if (!textarea) return;
            const pos = textarea.selectionStart;
            const filteredLines = textarea.value.split('\n');
            const filteredLineNum = textarea.value.substr(0, pos).split('\n').length - 1;
            const selectedLineContent = filteredLines[filteredLineNum]?.trim();
            textarea.value = originalConfig;
            const originalLines = originalConfig.split('\n');
            let idx = originalLines.findIndex(line => line.trim() === selectedLineContent);
            if (idx >= 0) {
                let start = 0;
                for (let i = 0; i < idx; i++) start += originalLines[i].length + 1;
                let end = start + originalLines[idx].length;
                textarea.focus();
                textarea.setSelectionRange(start, end);
                const lineHeight = textarea.scrollHeight / originalLines.length;
                textarea.scrollTop = lineHeight * (idx - 5);
            }
        }
        function copyEditorContent() {
            var editor = document.getElementById('configTextarea');
            var hidden = document.getElementById('editedConfigHidden');
            if (editor && hidden) {
                hidden.value = editor.value;
            }
        }
    </script>
</body>
</html>