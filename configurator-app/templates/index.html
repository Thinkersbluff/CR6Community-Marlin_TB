<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marlin Configurator</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body>
<div class="container mt-5">
    <h1>Marlin Configurator</h1>
    <form method="POST" enctype="multipart/form-data" class="d-flex flex-wrap align-items-center gap-2 mb-2">
        <input class="form-control form-control-sm w-auto" type="file" id="configFile" name="configFile" accept=".h,.ini,.txt" style="max-width:220px;">
        <input class="form-control form-control-sm w-auto" type="url" id="configUrl" name="configUrl" placeholder="Paste config URL" style="max-width:220px;">
        <button type="submit" class="btn btn-primary btn-sm">Load</button>
        {% if config_content %}
        <form method="POST" action="/edit" class="d-inline">
            <input type="hidden" name="filename" value="{{ config_source.split('/')[-1] if config_source else 'configuration.h' }}">
            <input type="hidden" name="editedConfig" id="editedConfigHidden">
            <button type="submit" class="btn btn-success btn-sm ms-2" onclick="copyEditorContent()">Download Modified Config</button>
        </form>
        {% endif %}
    </form>
    {% if config_content %}
    <hr>
    {% if config_source %}
    <div class="small text-muted mb-2"><strong>Loaded file:</strong> {{ config_source }}</div>
    {% endif %}
    <div id="configEditor">
        <h2 class="mt-4">Edit {{ config_source|replace('https://','')|replace('github.com/','')|replace('raw.githubusercontent.com/','')|replace('blob/','')|replace('/','_') if config_source else 'Configuration' }}</h2>
        <div class="mb-2 d-flex flex-wrap align-items-center gap-2">
            <input type="checkbox" id="hideComments" onclick="toggleComments()">
            <label for="hideComments" class="me-2 mb-0">Hide Comments</label>
            <label for="topicFilter" class="me-2 mb-0">Show:</label>
            <select id="topicFilter" onchange="filterTopic()" class="form-select form-select-sm w-auto">
                <option value="all">All Settings</option>
                <option value="nozzle">Nozzle Temperature</option>
                <option value="bed">Bed Temperature</option>
                <option value="motors">Motors</option>
                <option value="enable">Enable Settings</option>
                <option value="setting">#define Sttings</option>
                <option value="commented_define">Commented #define</option>
            </select>
            <label for="searchTerm" class="me-2 mb-0">Keyword Filter:</label>
            <input type="text" id="searchTerm" class="form-control form-control-sm w-auto" placeholder="Type to filter..." oninput="refreshFilters()" style="max-width:140px;">
            <button type="button" class="btn btn-outline-secondary btn-sm ms-2" onclick="viewInContext()">View in Context</button>
        </div>
        <div style="position:relative; width:100%; height:400px;">
            <textarea class="form-control" name="editedConfig" id="configTextarea" rows="20" style="font-family:monospace; resize:vertical; height:100%; min-height:100%; box-sizing:border-box;">{{ config_content }}</textarea>
        </div>
    </div>
<script>
function copyEditorContent() {
    var editor = document.getElementById('configTextarea');
    var hidden = document.getElementById('editedConfigHidden');
    if (editor && hidden) {
        hidden.value = editor.value;
    }
}


</script>
    </div>
    {% endif %}
</div>
<script>
let originalConfig = null;
let filteredConfig = null;
let lastFilteredLine = null;
window.addEventListener('DOMContentLoaded', function() {
    // Reset filters to defaults
    if (document.getElementById('hideComments')) {
        document.getElementById('hideComments').checked = false;
    }
    if (document.getElementById('topicFilter')) {
        document.getElementById('topicFilter').value = 'all';
    }
    if (document.getElementById('searchTerm')) {
        document.getElementById('searchTerm').value = '';
    }
    // Set original config
    if (document.getElementById('configTextarea')) {
        originalConfig = document.getElementById('configTextarea').value;
        // Ensure textarea shows all content
        document.getElementById('configTextarea').value = originalConfig;
        filteredConfig = originalConfig;
    }
});
function toggleComments() {
    const textarea = document.getElementById('configTextarea');
    let lines = originalConfig.split('\n');
    let filtered = [];
    let inBlock = false;
    for (let line of lines) {
        let trimmed = line.trim();
        if (trimmed.startsWith('/*')) inBlock = true;
        if (!inBlock && !trimmed.startsWith('//')) filtered.push(line);
        if (inBlock && trimmed.endsWith('*/')) inBlock = false;
    }
    if (document.getElementById('hideComments').checked) {
        filteredConfig = filtered.join('\n');
    } else {
        filteredConfig = originalConfig;
    }
    filterTopic();
}
function filterTopic() {
    const textarea = document.getElementById('configTextarea');
    let lines = filteredConfig.split('\n');
    let topic = document.getElementById('topicFilter').value;
    if (topic === 'all') {
        textarea.value = lines.join('\n');
        filterSearch();
        return;
    }
    let keywords = {
        nozzle: ['NOZZLE', 'TEMP_SENSOR', 'HEATER', 'HOTEND'],
        bed: ['BED', 'TEMP_SENSOR_BED', 'HEATER_BED'],
        motors: ['MOTOR', 'STEPPER', 'AXIS'],
        enable: ['ENABLE '],
        setting: ['#define']
    };
    let filtered;
    if (topic === 'setting') {
        filtered = lines.filter(line => line.trim().startsWith('#define'));
    } else if (topic === 'commented_define') {
        // Only show commented #define if Hide Comments is NOT checked
        if (document.getElementById('hideComments').checked) {
            filtered = [];
        } else {
            filtered = lines.filter(line => line.trim().startsWith('//') && line.includes('#define'));
        }
    } else {
        filtered = lines.filter(line => {
            for (let key of keywords[topic]) {
                if (line.toUpperCase().includes(key)) return true;
            }
            return false;
        });
    }
    textarea.value = filtered.join('\n');
    // Save last filtered line for context
    lastFilteredLine = filtered.length > 0 ? filtered[filtered.length - 1] : null;
    filterSearch();
}
function filterSearch() {
    const textarea = document.getElementById('configTextarea');
    let searchTerm = document.getElementById('searchTerm').value.trim().toLowerCase();
    if (!searchTerm) return;
    let lines = textarea.value.split('\n');
    let filtered = lines.filter(line => line.toLowerCase().includes(searchTerm));
    textarea.value = filtered.join('\n');
    // Save last filtered line for context
    lastFilteredLine = filtered.length > 0 ? filtered[filtered.length - 1] : null;
}
function refreshFilters() {
    // Reapply all filters in order: comments, topic, then search
    toggleComments();
    filterTopic();
    filterSearch();
}
function viewInContext() {
    // Show full document and highlight the line that matches the selected line in the filtered view
    const textarea = document.getElementById('configTextarea');
    if (!textarea) return;
    // Get the content of the current line in the filtered view
    const pos = textarea.selectionStart;
    const filteredLines = textarea.value.split('\n');
    const filteredLineNum = textarea.value.substr(0, pos).split('\n').length - 1;
    const selectedLineContent = filteredLines[filteredLineNum]?.trim();
    // Restore the full document
    textarea.value = originalConfig;
    const originalLines = originalConfig.split('\n');
    // Find the first matching line in the original document
    let idx = originalLines.findIndex(line => line.trim() === selectedLineContent);
    if (idx >= 0) {
        let start = 0;
        for (let i = 0; i < idx; i++) start += originalLines[i].length + 1;
        let end = start + originalLines[idx].length;
        textarea.focus();
        textarea.setSelectionRange(start, end);
        // Optionally scroll to the line
        const lineHeight = textarea.scrollHeight / originalLines.length;
        textarea.scrollTop = lineHeight * (idx - 5);
    }
    // Reset all filters
    if (document.getElementById('hideComments')) document.getElementById('hideComments').checked = false;
    if (document.getElementById('topicFilter')) document.getElementById('topicFilter').value = 'all';
    if (document.getElementById('searchTerm')) document.getElementById('searchTerm').value = '';
}
function showEditor() {
    // No longer needed; editor is always shown when file is loaded.
}
</script>
