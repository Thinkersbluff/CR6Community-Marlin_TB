<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marlin Configurator</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body>
    <div class="container mt-5">
        <ul class="nav nav-tabs mb-4">
            <li class="nav-item">
                <a class="nav-link" href="/start-here">Start Here</a>
            </li>
            <li class="nav-item">
                <a class="nav-link active" aria-current="page" href="/configurator">Configurator</a>
            </li>
        </ul>
        <h1>Marlin Configurator</h1>
        <div class="mb-3">
            <label for="configExampleSelect" class="form-label fw-bold">Select the configuration example to edit:</label>
            <select id="configExampleSelect" class="form-select w-auto">
                <option value="">-- Select --</option>
                <option value="btt-skr-cr6-with-btt-tft">btt-skr-cr6-with-btt-tft</option>
                <option value="btt-skr-cr6-with-btt-tft-biqu-h2">btt-skr-cr6-with-btt-tft-biqu-h2</option>
                <option value="btt-skr-cr6-with-btt-tft-e3d-hemera">btt-skr-cr6-with-btt-tft-e3d-hemera</option>
                <option value="btt-skr-cr6-with-stock-creality-tft">btt-skr-cr6-with-stock-creality-tft</option>
                <option value="btt-skr-cr6-with-stock-creality-tft-biqu-h2">btt-skr-cr6-with-stock-creality-tft-biqu-h2</option>
                <option value="btt-skr-cr6-with-stock-creality-tft-neopixel">btt-skr-cr6-with-stock-creality-tft-neopixel</option>
                <option value="cr10-smart-btt-skr-cr6-with-btt-tft">cr10-smart-btt-skr-cr6-with-btt-tft</option>
                <option value="cr10-smart-btt-skr-cr6-with-stock-creality-tft">cr10-smart-btt-skr-cr6-with-stock-creality-tft</option>
                <option value="cr6-max-btt-skr-cr6-with-btt-tft">cr6-max-btt-skr-cr6-with-btt-tft</option>
                <option value="cr6-max-btt-skr-cr6-with-stock-creality-tft">cr6-max-btt-skr-cr6-with-stock-creality-tft</option>
                <option value="cr6-max-stock-mb">cr6-max-stock-mb</option>
                <option value="cr6-se-v4.5.2-mb">cr6-se-v4.5.2-mb</option>
                <option value="cr6-se-v4.5.2-mb-no-watchdog">cr6-se-v4.5.2-mb-no-watchdog</option>
                <option value="cr6-se-v4.5.3-mb">cr6-se-v4.5.3-mb</option>
            </select>
            <div id="fileListArea" class="mt-2"></div>
        </div>
        <form id="configForm" method="POST" enctype="multipart/form-data" class="d-flex flex-wrap align-items-center gap-2 mb-2" action="/edit">
            <input class="form-control form-control-sm w-auto" type="file" id="configFile" name="configFile" accept=".h,.ini,.txt" style="max-width:220px; display:none;">
            <input class="form-control form-control-sm w-auto" type="url" id="configUrl" name="configUrl" placeholder="Paste config URL" style="max-width:220px; display:none;">
            {% if config_content %}
                <input type="hidden" name="filename" value="{{ config_source.split('/')[-1] if config_source else 'configuration.h' }}">
                <input type="hidden" name="editedConfig" id="editedConfigHidden">
                <button type="button" class="btn btn-success btn-sm ms-2" id="saveDownloadBtn">Save and Download</button>
            {% endif %}
        </form>
        {% if config_content %}
            <hr>
            {% if config_source %}
                <div class="small text-muted mb-2"><strong>Loaded file:</strong> {{ config_source }}</div>
            {% endif %}
            <div id="configEditor">
                <h2 class="mt-4">Edit {{ config_source|replace('https://','')|replace('github.com/','')|replace('raw.githubusercontent.com/','')|replace('blob/','')|replace('/','_') if config_source else 'Configuration' }}</h2>
                <div class="mb-2 d-flex flex-wrap align-items-center gap-2">
                    <input type="checkbox" id="hideComments" onclick="refreshFilters()">
                    <label for="hideComments" class="me-2 mb-0">Hide Comments</label>
                    <label for="topicFilter" class="me-2 mb-0">Show:</label>
                    <select id="topicFilter" onchange="refreshFilters()" class="form-select form-select-sm w-auto">
                        <option value="all">All Settings</option>
                        <option value="nozzle">Nozzle Temperature</option>
                        <option value="bed">Bed Temperature</option>
                        <option value="motors">Motors</option>
                        <option value="enable">Enable Settings</option>
                        <option value="setting">#define Sttings</option>
                        <option value="commented_define">Commented #define</option>
                    </select>
                    <label for="searchTerm" class="me-2 mb-0">Keyword Filter:</label>
                    <input type="text" id="searchTerm" class="form-control form-control-sm w-auto" placeholder="Type to filter..." oninput="refreshFilters()" style="max-width:140px;">
                    <button type="button" class="btn btn-outline-secondary btn-sm ms-2" onclick="viewInContext()">View in Context</button>
                    <button type="button" class="btn btn-primary btn-sm ms-2" onclick="saveEditorContent()">Save</button>
                </div>
                <div style="position:relative; width:100%; height:400px;">
                    <textarea class="form-control" name="editedConfig" id="configTextarea" rows="20" style="font-family:monospace; resize:vertical; height:100%; min-height:100%; box-sizing:border-box;">{{ config_content }}</textarea>
                </div>
            </div>
        {% endif %}
    </div>
    <script>
    let originalConfig = null;
    let editedConfig = null;
    let filteredConfig = null;
    let lastFilteredLine = null;

    document.addEventListener('DOMContentLoaded', function() {
        // File list logic
        let select = document.getElementById('configExampleSelect');
        let fileListArea = document.getElementById('fileListArea');
        function fetchAndRenderFileList() {
            let folder = select.value;
            fileListArea.innerHTML = '';
            if (folder) {
                fetch(`/list-config-files?folder=${encodeURIComponent(folder)}`)
                    .then(response => response.json())
                    .then(data => {
                        console.log('File list response:', data);
                        if (data.files && data.files.length > 0) {
                            let html = '<div class="fw-bold">Files in selected folder:</div><ul class="list-group">';
                            for (let f of data.files) {
                                html += `<li class="list-group-item list-group-item-action" style="cursor:pointer;" onclick="window.location.href='/configurator?folder=${encodeURIComponent(folder)}&filename=${encodeURIComponent(f)}'">${f}</li>`;
                            }
                            html += '</ul>';
                            fileListArea.innerHTML = html;
                        } else {
                            fileListArea.innerHTML = '<div class="text-muted">No config files found in this folder.</div>';
                        }
                    })
                    .catch(err => {
                        fileListArea.innerHTML = '<div class="text-danger">Error fetching file list.</div>';
                        console.error('Error fetching file list:', err);
                    });
            }
        }
        if (select) {
            select.addEventListener('change', fetchAndRenderFileList);
            // On page load, if a folder is already selected, fetch its file list
            if (select.value) {
                fetchAndRenderFileList();
            }
        }

        // Initialize config variables
        const textarea = document.getElementById('configTextarea');
        if (textarea) {
            originalConfig = textarea.value;
            editedConfig = textarea.value;
            filteredConfig = textarea.value;
            textarea.addEventListener('input', function() {
                editedConfig = this.value;
            });
        }
        // Restore full edited text when filter changes to 'all'
        const topicFilter = document.getElementById('topicFilter');
        if (topicFilter) {
            topicFilter.addEventListener('change', function() {
                if (this.value === 'all' && textarea) {
                    textarea.value = editedConfig;
                    filteredConfig = editedConfig;
                }
            });
        }
        // Save and Download button logic
        const saveDownloadBtn = document.getElementById('saveDownloadBtn');
        if (saveDownloadBtn) {
            saveDownloadBtn.onclick = function() {
                // Always restore full edited config before download
                if (textarea) {
                    textarea.value = editedConfig;
                }
                const hidden = document.getElementById('editedConfigHidden');
                if (hidden) {
                    hidden.value = editedConfig;
                }
                // Submit the form
                document.getElementById('configForm').submit();
            };
        }
        // Initial Save button visibility
        updateSaveButtonVisibility();
        // Update Save button visibility on filter changes
        if (topicFilter) topicFilter.addEventListener('change', updateSaveButtonVisibility);
        if (searchTerm) searchTerm.addEventListener('input', updateSaveButtonVisibility);
        if (hideComments) hideComments.addEventListener('change', updateSaveButtonVisibility);
    });
    function refreshFilters() {
        const textarea = document.getElementById('configTextarea');
        let lines = editedConfig ? editedConfig.split('\n') : originalConfig.split('\n');
        let filtered = lines;
        // Hide comments
        if (hideComments && hideComments.checked) {
            let temp = [];
            let inBlock = false;
            for (let line of filtered) {
                let trimmed = line.trim();
                if (trimmed.startsWith('/*')) inBlock = true;
                if (!inBlock && !trimmed.startsWith('//')) temp.push(line);
                if (inBlock && trimmed.endsWith('*/')) inBlock = false;
            }
            filtered = temp;
        }
        // Topic filter
        if (topicFilter && topicFilter.value !== 'all') {
            const keywords = {
                nozzle: ['NOZZLE', 'TEMP_SENSOR', 'HEATER', 'HOTEND'],
                bed: ['BED', 'TEMP_SENSOR_BED', 'HEATER_BED'],
                motors: ['MOTOR', 'STEPPER', 'AXIS'],
                enable: ['ENABLE '],
                setting: ['#define']
            };
            if (topicFilter.value === 'setting') {
                filtered = filtered.filter(line => line.trim().startsWith('#define'));
            } else if (topicFilter.value === 'commented_define') {
                if (!hideComments || !hideComments.checked) {
                    filtered = filtered.filter(line => line.trim().startsWith('//') && line.includes('#define'));
                } else {
                    filtered = [];
                }
            } else {
                filtered = filtered.filter(line => {
                    for (let key of keywords[topicFilter.value]) {
                        if (line.toUpperCase().includes(key)) return true;
                    }
                    return false;
                });
            }
        }
        // Keyword filter
        let searchTermValue = searchTerm ? searchTerm.value.trim().toLowerCase() : '';
        if (searchTermValue) {
            filtered = filtered.filter(line => line.toLowerCase().includes(searchTermValue));
        }
        // Update textarea
        if (textarea) {
            textarea.value = filtered.join('\n');
        }
        updateSaveButtonVisibility();
    }
    function saveEditorContent() {
        const textarea = document.getElementById('configTextarea');
        if (textarea) {
            editedConfig = textarea.value;
            alert('Changes saved.');
        }
    }
    function updateSaveButtonVisibility() {
        const saveBtn = document.querySelector('button.btn-primary');
        if (saveBtn) {
            if (
                topicFilter && topicFilter.value === 'all' &&
                searchTerm && searchTerm.value.trim() === '' &&
                hideComments && !hideComments.checked
            ) {
                saveBtn.style.display = '';
            } else {
                saveBtn.style.display = 'none';
            }
        }
    }
    function viewInContext() {
        const textarea = document.getElementById('configTextarea');
        if (!textarea) return;
        // Get selected filtered line
        const pos = textarea.selectionStart;
        const filteredLines = textarea.value.split('\n');
        const filteredLineNum = textarea.value.substr(0, pos).split('\n').length - 1;
        const selectedLineContent = filteredLines[filteredLineNum]?.trim();
        // Clear all filters
        if (topicFilter) topicFilter.value = 'all';
        if (searchTerm) searchTerm.value = '';
        if (hideComments) hideComments.checked = false;
        // Restore full config
        textarea.value = originalConfig;
        // Find and select the line in the full config
        const originalLines = originalConfig.split('\n');
        let idx = originalLines.findIndex(line => line.trim() === selectedLineContent);
        if (idx >= 0) {
            let start = 0;
            for (let i = 0; i < idx; i++) start += originalLines[i].length + 1;
            let end = start + originalLines[idx].length;
            textarea.focus();
            textarea.setSelectionRange(start, end);
            const lineHeight = textarea.scrollHeight / originalLines.length;
            textarea.scrollTop = lineHeight * (idx - 5);
        }
        updateSaveButtonVisibility();
    }
    </script>
    <script src="/static/popup.js"></script>
</body>
</html>